name: Update Daily Production Count

on:
  schedule:
    - cron: '40 0 * * *'
  workflow_dispatch:

jobs:
  update-daily-production-counts:
    runs-on: ubuntu-latest

    steps:
      - name: Install PostgreSQL CLI
        run: sudo apt-get install -y postgresql-client

      - name: Run INSERT aggregation via psql
        run: |
          echo "Running daily production count aggregation..."
          psql "$DATABASE_URL" -c "
            INSERT INTO daily_production_counts (production_date, product_id, piece_count)
            SELECT
                ((date_trunc('day', now() AT TIME ZONE 'Asia/Kolkata') - INTERVAL '1 day' + INTERVAL '6 hour'))::date AS production_date,
                product_id,
                COUNT(*) AS piece_count
            FROM telemetry
            WHERE
                timestamp >= ((date_trunc('day', now() AT TIME ZONE 'Asia/Kolkata') - INTERVAL '1 day' + INTERVAL '30 min') AT TIME ZONE 'UTC')
                AND timestamp < ((date_trunc('day', now() AT TIME ZONE 'Asia/Kolkata') + INTERVAL '30 min') AT TIME ZONE 'UTC')
            GROUP BY production_date, product_id
            ON CONFLICT (production_date, product_id) DO UPDATE
            SET piece_count = EXCLUDED.piece_count;
          "
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}